@page
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model DashboardModel

<head><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
</head>
<h2>Dashboard</h2>

<!-- Display Messages -->
@if (Model.StatusMessage != null)
{
    <div>@Model.StatusMessage</div>
}

<!-- Section for Products -->
<h3>Products</h3>
<div>
    <h4>Add New Product</h4>
    <input type="text" id="newProductName" placeholder="Name" />
    <input type="number" id="newProductPrice" placeholder="Price" />
    <button type="button" onclick="addProduct()">Add Product</button>
</div>

<h4>Existing Products</h4>
@if (Model.Products.Any())
{
    @foreach (var product in Model.Products)
    {
        <div>
            <input type="hidden" id="productId_@product.id" value="@product.id">
            <input type="text" id="productName_@product.id" value="@product.Name" />
            <input type="number" id="productPrice_@product.id" value="@product.Price" />
            <button type="button" onclick="updateProduct(@product.id)">Update</button>
        </div>
        <button type="button" onclick="deleteProduct(@product.id)">Delete</button>
    }
}
else
{
    <p>No products found.</p>
}


<script>
    function deleteProduct(productId) {
        if (!confirm('Are you sure you want to delete this product?')) {
            return;
        }
        $.ajax({
            url: '?handler=DeleteProduct', // Adjust this URL based on your page routing.
            type: 'POST',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val() // Ensure this token is included somewhere in your page, typically in a meta tag or a hidden input
            },
            data: {
                id: productId
            },
            success: function (result) {
                if (result.success) {
                    alert('Product deleted successfully');
                    refreshPage();
                } else {
                    alert(result.message); // Show server-side error message
                }
            },
            error: function (error) {
                alert('Error deleting product. Please try again. ' + error.responseText);
            }
        });
    }
    function updateProduct(productId) {
        var name = document.getElementById('productName_' + productId).value;
        var price = parseFloat(document.getElementById('productPrice_' + productId).value);
        

        $.ajax({
            url: '?handler=UpdateProduct',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            data: JSON.stringify({
                id: productId,
                UpdatedProductName: name,
                UpdatedProductPrice: price
            }),
            success: function (response) {
                if (response.success) {
                    alert('Product updated successfully!');
                    // Optionally refresh part of your page or update the UI
                } else {
                    alert('Update failed: ' + response.message);
                }
            },
            error: function () {
                alert('Error updating product. Please try again.');
            }
        });
    }
    function addProduct() {
        var name = document.getElementById('newProductName').value;
        var price = parseFloat(document.getElementById('newProductPrice').value);

        $.ajax({
            url: '?handler=AddProduct',
            type: 'POST',
            contentType: 'application/json',
            headers: {
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            data: JSON.stringify({ name: name, price: price }),
            success: function(response) {
                if (response.success) {
                    alert('Product added successfully!');
                    // Optionally, clear the form fields or update the UI
                    document.getElementById('newProductName').value = '';
                    document.getElementById('newProductPrice').value = '';
                } else {
                    alert('Failed to add product: ' + response.message);
                }
            },
            error: function(xhr) {
                alert('Error adding product. Please try again.');
                console.error('Error details:', xhr.responseText);
            }
        });
    }

</script>
